<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess.com Wrapped</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .slide {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            height: 100vh;
            width: 100%;
        }
        .slide.active {
            display: block;
            opacity: 1;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stat-card {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .gradient-text {
            background: linear-gradient(45deg, #1DB954, #4CAF50);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .container {
            height: 100vh;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-black text-white">
    <div class="container mx-auto px-4">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="h-screen flex flex-col justify-center items-center">
            <h1 class="text-6xl font-bold mb-8 gradient-text">Chess.com Wrapped</h1>
            <div class="max-w-md w-full">
                <div class="bg-gray-900 p-8 rounded-lg shadow-lg">
                    <p class="text-xl mb-6">Discover your chess journey of 2024</p>
                    <input type="text" id="username" placeholder="Enter Chess.com username" 
                           class="w-full px-4 py-3 rounded bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-green-500 mb-4">
                    <button onclick="startAnalysis()" 
                            class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 px-6 py-3 rounded-lg font-bold text-lg transition duration-300">
                        Generate Your Wrapped
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="hidden h-screen flex items-center justify-center">
            <div class="max-w-md w-full">
                <div class="bg-gray-900 p-8 rounded-lg shadow-lg">
                    <div class="animate-pulse">
                        <p class="text-2xl mb-4">Analyzing your chess journey...</p>
                        <div class="w-full bg-gray-800 rounded-full h-2 mb-4">
                            <div id="progress-bar" class="progress-bar bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-gray-400" id="loading-text">Fetching your games...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results-container" class="hidden">
            <!-- Slides will be dynamically inserted here -->
        </div>
    </div>

    <script>
        let currentSlide = 0;
        const slides = [];
        let playerStats = {};

        async function startAnalysis() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a Chess.com username');
                return;
            }

            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('loading-screen').classList.remove('hidden');
            
            try {
                await fetchAndAnalyzeData(username);
            } catch (error) {
                alert('Error fetching data: ' + error.message);
                document.getElementById('welcome-screen').style.display = 'block';
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        async function fetchAndAnalyzeData(username) {
            updateLoadingText('Fetching player profile...');
            updateProgress(10);

            // Get player profile first
            const profileUrl = `https://api.chess.com/pub/player/${username}`;
            const profileResponse = await fetch(profileUrl);
            if (!profileResponse.ok) throw new Error('User not found');
            const profileData = await profileResponse.json();

            const playerName = profileData.name || username;
            const playerAvatar = profileData.avatar || 'https://www.chess.com/bundles/web/images/user-image.007dad08.svg';

            updateLoadingText('Fetching player stats...');
            updateProgress(20);

            const statsResponse = await fetch(`https://api.chess.com/pub/player/${username}/stats`);
            if (!statsResponse.ok) throw new Error('Could not fetch player stats');
            const stats = await statsResponse.json();

            updateLoadingText('Fetching recent games...');
            updateProgress(30);

            // Get current month's games
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            
            // Fetch archives
            const archives = await fetchArchives(username);
            
            updateLoadingText('Processing your games...');
            updateProgress(40);

            // Fetch all games from 2024
            const allGames = [];
            let processedArchives = 0;
            
            for (const archiveUrl of archives) {
                try {
                    const gamesResponse = await fetch(archiveUrl);
                    if (gamesResponse.ok) {
                        const gamesData = await gamesResponse.json();
                        allGames.push(...gamesData.games);
                    }
                    processedArchives++;
                    updateProgress(40 + (processedArchives / archives.length) * 30);
                } catch (error) {
                    console.error('Error fetching archive:', archiveUrl, error);
                }
            }

            updateLoadingText('Analyzing your chess journey...');
            updateProgress(80);

            playerStats = processStats(stats, allGames, username, profileData);
            
            createSlides(playerName, playerAvatar);
            
            updateProgress(100);
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('results-container').classList.remove('hidden');
                showSlide(0);
            }, 500);
        }

        async function fetchArchives(username) {
            try {
                const archivesUrl = `https://api.chess.com/pub/player/${username}/games/archives`;
                const archivesResponse = await fetch(archivesUrl);
                if (!archivesResponse.ok) throw new Error('Failed to fetch archives');
                const archives = await archivesResponse.json();
                
                // Get the current year's archives
                const currentYear = new Date().getFullYear();
                const currentYearArchives = archives.archives.filter(url => {
                    const urlParts = url?.split('/') || [];
                    return urlParts[urlParts.length - 2] === currentYear.toString();
                }) || [];

                return currentYearArchives;
            } catch (error) {
                console.error('Error fetching archives:', error);
                throw new Error('Failed to fetch game archives');
            }
        }

        function processStats(stats, games, username, profile) {
            try {
                // Initialize stats object with default values
                const processedStats = {
                    rapid: stats?.chess_rapid || { last: { rating: 0 }, best: { rating: 0 } },
                    blitz: stats?.chess_blitz || { last: { rating: 0 }, best: { rating: 0 } },
                    bullet: stats?.chess_bullet || { last: { rating: 0 }, best: { rating: 0 } },
                    puzzle: stats?.puzzle || { last: { rating: 0 }, best: { rating: 0 } },
                    games: {
                        total: games.length,
                        wins: 0,
                        losses: 0,
                        draws: 0,
                        bestWinStreak: 0,
                        currentWinStreak: 0,
                        timeControls: {},
                        openings: {},
                        colors: { white: 0, black: 0 },
                        bestWin: {
                            rating: 0,
                            opponent: '',
                            gameUrl: '',
                            date: null
                        },
                        fastestWin: {
                            moves: Infinity,
                            opponent: '',
                            gameUrl: '',
                            date: null
                        },
                        longestGame: {
                            moves: 0,
                            opponent: '',
                            gameUrl: '',
                            date: null
                        },
                        averageGameLength: 0,
                        totalMoves: 0,
                        accuracy: {
                            sum: 0,
                            count: 0,
                            best: {
                                value: 0,
                                gameUrl: '',
                                opponent: '',
                                date: null
                            }
                        },
                        timeOfDay: {
                            morning: 0,    // 6-12
                            afternoon: 0,  // 12-18
                            evening: 0,    // 18-24
                            night: 0       // 0-6
                        },
                        dayOfWeek: {
                            mon: 0, tue: 0, wed: 0,
                            thu: 0, fri: 0, sat: 0, sun: 0
                        },
                        openingColors: {
                            white: {},
                            black: {}
                        },
                        averageOpponentRating: {
                            sum: 0,
                            count: 0
                        },
                        resultsByTimeControl: {}
                    },
                    profile: {
                        joinDate: profile?.joined ? new Date(profile.joined * 1000) : new Date(),
                        lastOnline: profile?.last_online ? new Date(profile.last_online * 1000) : new Date(),
                        country: profile?.country || '',
                        followers: profile?.followers || 0,
                        membershipDuration: Math.floor((Date.now() - (profile?.joined || Date.now()/1000) * 1000) / (1000 * 60 * 60 * 24))
                    }
                };

                let currentWinStreak = 0;
                let currentLossStreak = 0;
                let bestLossStreak = 0;
                
                games.forEach(game => {
                    try {
                        if (!game || !game.white || !game.black) {
                            console.warn('Skipping invalid game:', game);
                            return;
                        }

                        const isWhite = game.white.username.toLowerCase() === username.toLowerCase();
                        const playerColor = isWhite ? 'white' : 'black';
                        const opponentColor = isWhite ? 'black' : 'white';
                        
                        // Safely get game end time
                        const gameDate = game.end_time ? new Date(game.end_time * 1000) : new Date();
                        const dayOfWeek = gameDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                        const hour = gameDate.getHours();
                        
                        // Track colors played
                        processedStats.games.colors[playerColor]++;

                        // Track time of day
                        if (hour >= 6 && hour < 12) processedStats.games.timeOfDay.morning++;
                        else if (hour >= 12 && hour < 18) processedStats.games.timeOfDay.afternoon++;
                        else if (hour >= 18 && hour < 24) processedStats.games.timeOfDay.evening++;
                        else processedStats.games.timeOfDay.night++;

                        // Track day of week
                        const dayKey = dayOfWeek.slice(0, 3); // Get first three letters of the day
                        processedStats.games.dayOfWeek[dayKey] = (processedStats.games.dayOfWeek[dayKey] || 0) + 1;

                        // Safely track average opponent rating
                        if (game[opponentColor] && typeof game[opponentColor].rating === 'number') {
                            processedStats.games.averageOpponentRating.sum += game[opponentColor].rating;
                            processedStats.games.averageOpponentRating.count++;
                        }

                        // Process game result
                        const whiteWon = game.white.result === 'win';
                        const blackWon = game.black.result === 'win';
                        const playerWon = (whiteWon && isWhite) || (blackWon && !isWhite);

                        if (playerWon) {
                            processedStats.games.wins++;
                            currentWinStreak++;
                            currentLossStreak = 0;
                            processedStats.games.bestWinStreak = Math.max(processedStats.games.bestWinStreak, currentWinStreak);

                            // Check for best win
                            if (game[opponentColor] && typeof game[opponentColor].rating === 'number') {
                                const opponentRating = game[opponentColor].rating;
                                if (opponentRating > processedStats.games.bestWin.rating) {
                                    processedStats.games.bestWin = {
                                        rating: opponentRating,
                                        opponent: game[opponentColor].username || 'Unknown',
                                        gameUrl: game.url || '',
                                        date: gameDate
                                    };
                                }
                            }

                            // Safely process PGN data
                            if (game.pgn) {
                                try {
                                    const moveCount = game.pgn.split('\n\n')[1]?.trim().split(/\s+/).filter(token => /^\d+\./.test(token)).length || Infinity;
                                    
                                    // Check for fastest win
                                    if (moveCount < processedStats.games.fastestWin.moves) {
                                        processedStats.games.fastestWin = {
                                            moves: moveCount,
                                            opponent: game[opponentColor].username || 'Unknown',
                                            gameUrl: game.url || '',
                                            date: gameDate
                                        };
                                    }

                                    // Check for longest game
                                    if (moveCount > processedStats.games.longestGame.moves) {
                                        processedStats.games.longestGame = {
                                            moves: moveCount,
                                            opponent: game[opponentColor].username || 'Unknown',
                                            gameUrl: game.url || '',
                                            date: gameDate
                                        };
                                    }
                                } catch (pgnError) {
                                    console.warn('Error processing PGN:', pgnError);
                                }
                            }
                        } else if (whiteWon || blackWon) {
                            processedStats.games.losses++;
                            currentWinStreak = 0;
                            currentLossStreak++;
                            bestLossStreak = Math.max(bestLossStreak, currentLossStreak);
                        } else {
                            processedStats.games.draws++;
                            currentWinStreak = 0;
                            currentLossStreak = 0;
                        }

                        // Safely track accuracy if available
                        if (game.accuracies) {
                            const playerAccuracy = isWhite ? game.accuracies.white : game.accuracies.black;
                            if (typeof playerAccuracy === 'number') {
                                processedStats.games.accuracy.sum += playerAccuracy;
                                processedStats.games.accuracy.count++;
                                
                                if (playerAccuracy > processedStats.games.accuracy.best.value) {
                                    processedStats.games.accuracy.best = {
                                        value: playerAccuracy,
                                        gameUrl: game.url || '',
                                        opponent: game[opponentColor].username || 'Unknown',
                                        date: gameDate
                                    };
                                }
                            }
                        }

                        // Safely track time controls
                        const timeControl = game.time_class || 'unknown';
                        processedStats.games.timeControls[timeControl] = (processedStats.games.timeControls[timeControl] || 0) + 1;
                        
                        if (!processedStats.games.resultsByTimeControl[timeControl]) {
                            processedStats.games.resultsByTimeControl[timeControl] = {
                                wins: 0,
                                losses: 0,
                                draws: 0
                            };
                        }

                        // Track results by time control
                        if (playerWon) {
                            processedStats.games.resultsByTimeControl[timeControl].wins++;
                        } else if (whiteWon || blackWon) {
                            processedStats.games.resultsByTimeControl[timeControl].losses++;
                        } else {
                            processedStats.games.resultsByTimeControl[timeControl].draws++;
                        }

                        // Safely track openings
                        if (game.pgn) {
                            try {
                                const openingMatch = game.pgn.match(/\[Opening "([^"]+)"\]/);
                                if (openingMatch) {
                                    const opening = openingMatch[1];
                                    processedStats.games.openings[opening] = (processedStats.games.openings[opening] || 0) + 1;
                                    
                                    const colorOpenings = processedStats.games.openingColors[playerColor];
                                    colorOpenings[opening] = (colorOpenings[opening] || 0) + 1;
                                }
                            } catch (openingError) {
                                console.warn('Error processing opening:', openingError);
                            }
                        }
                    } catch (gameError) {
                        console.warn('Error processing game:', gameError);
                    }
                });
                
                // Calculate averages and sort data
                processedStats.games.averageGameLength = Math.round(processedStats.games.totalMoves / games.length);
                processedStats.games.averageAccuracy = processedStats.games.accuracy.count > 0 
                    ? Math.round(processedStats.games.accuracy.sum / processedStats.games.accuracy.count) 
                    : null;

                // Sort openings by frequency
                processedStats.games.topOpenings = Object.entries(processedStats.games.openings)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                // Find most played time control
                processedStats.games.favoriteTimeControl = Object.entries(processedStats.games.timeControls)
                    .sort((a, b) => b[1] - a[1])[0];

                // Calculate average opponent rating
                processedStats.games.averageOpponentRating = Math.round(processedStats.games.averageOpponentRating.sum / processedStats.games.averageOpponentRating.count);

                return processedStats;
            } catch (error) {
                console.error('Error processing stats:', error);
                throw new Error('Failed to process player statistics');
            }
        }

        function createSlides(playerName, playerAvatar) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            
            // Welcome slide
            const welcomeSlide = createSlide();
            welcomeSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-5xl font-bold mb-8 gradient-text">Your Chess Journey 2024</h2>
                    <p class="text-2xl mb-8">Let's explore your year in chess!</p>
                    <button onclick="nextSlide()" class="bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Begin →
                    </button>
                </div>
            `;
            container.appendChild(welcomeSlide);

            // Profile Overview slide
            const profileSlide = createSlide();
            const memberSince = playerStats.profile.joinDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long'
            });
            const lastOnline = playerStats.profile.lastOnline.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            profileSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-4xl font-bold mb-8">Your Chess Profile</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto px-4">
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Chess.com Member</h3>
                            <div class="text-3xl font-bold text-blue-500">Since ${memberSince}</div>
                            <div class="text-gray-400 text-sm">Last Online: ${lastOnline}</div>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Community</h3>
                            <div class="text-3xl font-bold text-purple-500">${playerStats.profile.followers}</div>
                            <div class="text-gray-400 text-sm">Followers</div>
                        </div>
                    </div>
                    <button onclick="nextSlide()" class="mt-8 bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Next →
                    </button>
                </div>
            `;
            container.appendChild(profileSlide);

            // Games Overview slide
            const gamesSlide = createSlide();
            const winRate = ((playerStats.games.wins / playerStats.games.total) * 100).toFixed(1);
            gamesSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-4xl font-bold mb-8">Your Chess Activity</h2>
                    <div class="text-7xl font-bold mb-8 gradient-text">${playerStats.games.total}</div>
                    <p class="text-2xl mb-4">Games Played in 2024</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto px-4 mt-8">
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Win Rate</h3>
                            <div class="text-3xl font-bold text-green-500">${winRate}%</div>
                            <div class="text-gray-400 text-sm">
                                ${playerStats.games.wins} Wins<br>
                                ${playerStats.games.losses} Losses<br>
                                ${playerStats.games.draws} Draws
                            </div>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Best Streak</h3>
                            <div class="text-3xl font-bold text-yellow-500">${playerStats.games.bestWinStreak}</div>
                            <div class="text-gray-400 text-sm">Consecutive Wins</div>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Average Opponent</h3>
                            <div class="text-3xl font-bold text-blue-500">${playerStats.games.averageOpponentRating}</div>
                            <div class="text-gray-400 text-sm">Rating</div>
                        </div>
                    </div>
                    <button onclick="nextSlide()" class="mt-8 bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Next →
                    </button>
                </div>
            `;
            container.appendChild(gamesSlide);

            // Playing Patterns slide
            const patternsSlide = createSlide();
            const favoriteTimeOfDay = Object.entries(playerStats.games.timeOfDay)
                .sort((a, b) => b[1] - a[1])[0][0];
            const favoriteDayOfWeek = Object.entries(playerStats.games.dayOfWeek)
                .sort((a, b) => b[1] - a[1])[0][0];
            
            const dayNames = {
                mon: 'Monday',
                tue: 'Tuesday',
                wed: 'Wednesday',
                thu: 'Thursday',
                fri: 'Friday',
                sat: 'Saturday',
                sun: 'Sunday'
            };

            const timeNames = {
                morning: 'Morning (6AM-12PM)',
                afternoon: 'Afternoon (12PM-6PM)',
                evening: 'Evening (6PM-12AM)',
                night: 'Night (12AM-6AM)'
            };
            
            patternsSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-4xl font-bold mb-8">Your Playing Patterns</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto px-4">
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Favorite Time to Play</h3>
                            <div class="text-3xl font-bold text-purple-500">${timeNames[favoriteTimeOfDay]}</div>
                            <div class="text-gray-400 text-sm">
                                Morning: ${playerStats.games.timeOfDay.morning} games<br>
                                Afternoon: ${playerStats.games.timeOfDay.afternoon} games<br>
                                Evening: ${playerStats.games.timeOfDay.evening} games<br>
                                Night: ${playerStats.games.timeOfDay.night} games
                            </div>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Most Active Day</h3>
                            <div class="text-3xl font-bold text-blue-500">${dayNames[favoriteDayOfWeek]}</div>
                            <div class="text-gray-400 text-sm">
                                ${Object.entries(playerStats.games.dayOfWeek)
                                    .map(([day, count]) => `${dayNames[day]}: ${count} games`)
                                    .join('<br>')}
                            </div>
                        </div>
                    </div>
                    <button onclick="nextSlide()" class="mt-8 bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Next →
                    </button>
                </div>
            `;
            container.appendChild(patternsSlide);

            // Time Controls Performance slide
            const timeControlsSlide = createSlide();
            const timeControlStats = Object.entries(playerStats.games.resultsByTimeControl)
                .map(([timeControl, stats]) => ({
                    timeControl,
                    ...stats,
                    total: stats.wins + stats.losses + stats.draws,
                    winRate: ((stats.wins / (stats.wins + stats.losses + stats.draws)) * 100).toFixed(1)
                }))
                .sort((a, b) => b.total - a.total);

            timeControlsSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-4xl font-bold mb-8">Performance by Time Control</h2>
                    <div class="grid grid-cols-1 gap-6 max-w-4xl mx-auto px-4">
                        ${timeControlStats.map(stats => `
                            <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                                <h3 class="text-xl font-bold mb-2">${stats.timeControl.charAt(0).toUpperCase() + stats.timeControl.slice(1)}</h3>
                                <div class="text-3xl font-bold text-green-500">${stats.winRate}% Win Rate</div>
                                <div class="text-gray-400 text-sm">
                                    ${stats.total} games played<br>
                                    ${stats.wins} wins, ${stats.losses} losses, ${stats.draws} draws
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="nextSlide()" class="mt-8 bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Next →
                    </button>
                </div>
            `;
            container.appendChild(timeControlsSlide);

            // Game Records slide
            const recordsSlide = createSlide();
            const bestAccuracy = playerStats.games.accuracy.best;
            const bestAccuracyDate = bestAccuracy.date?.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            recordsSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-4xl font-bold mb-8">Your Game Records</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto px-4">
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Longest Game</h3>
                            <div class="text-3xl font-bold text-yellow-500">${playerStats.games.longestGame.moves} moves</div>
                            <div class="text-gray-400 text-sm">
                                Against ${playerStats.games.longestGame.opponent}<br>
                                <a href="${playerStats.games.longestGame.gameUrl}" target="_blank" class="text-blue-400 hover:text-blue-300">View Game →</a>
                            </div>
                        </div>
                        ${bestAccuracy.value ? `
                            <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                                <h3 class="text-xl font-bold mb-2">Best Accuracy</h3>
                                <div class="text-3xl font-bold text-green-500">${bestAccuracy.value.toFixed(1)}%</div>
                                <div class="text-gray-400 text-sm">
                                    Against ${bestAccuracy.opponent}<br>
                                    ${bestAccuracyDate}<br>
                                    <a href="${bestAccuracy.gameUrl}" target="_blank" class="text-blue-400 hover:text-blue-300">View Game →</a>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <button onclick="nextSlide()" class="mt-8 bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Next →
                    </button>
                </div>
            `;
            container.appendChild(recordsSlide);

            // Openings Analysis slide
            const openingsSlide = createSlide();
            
            // Process openings data
            const processOpenings = (openings) => {
                return Object.entries(openings)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([opening, count], index) => ({
                        opening,
                        count,
                        percentage: ((count / Object.values(openings).reduce((a, b) => a + b, 0)) * 100).toFixed(1)
                    }));
            };

            const topWhiteOpenings = processOpenings(playerStats.games.openingColors.white);
            const topBlackOpenings = processOpenings(playerStats.games.openingColors.black);

            const createOpeningsList = (openings) => {
                if (openings.length === 0) return '<div class="text-gray-400">No opening data available</div>';
                
                return openings.map((data, index) => `
                    <div class="flex justify-between items-center py-2">
                        <div class="flex-1">
                            <span class="text-gray-300">${index + 1}. ${data.opening}</span>
                        </div>
                        <div class="text-gray-400 ml-4">
                            ${data.count} games (${data.percentage}%)
                        </div>
                    </div>
                `).join('');
            };

            openingsSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-4xl font-bold mb-8">Your Opening Repertoire</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto px-4">
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-4">As White</h3>
                            <div class="space-y-2">
                                ${createOpeningsList(topWhiteOpenings)}
                            </div>
                            <div class="text-sm text-gray-400 mt-4">
                                Total White Games: ${playerStats.games.colors.white}
                            </div>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-4">As Black</h3>
                            <div class="space-y-2">
                                ${createOpeningsList(topBlackOpenings)}
                            </div>
                            <div class="text-sm text-gray-400 mt-4">
                                Total Black Games: ${playerStats.games.colors.black}
                            </div>
                        </div>
                    </div>
                    <button onclick="nextSlide()" class="mt-8 bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Next →
                    </button>
                </div>
            `;
            container.appendChild(openingsSlide);

            // Ratings slide
            const ratingSlide = createSlide();
            ratingSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-4xl font-bold mb-8">Your Ratings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto px-4">
                        ${['bullet', 'blitz', 'rapid'].map(type => `
                            <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                                <h3 class="text-2xl font-bold mb-4">${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
                                <div class="text-3xl font-bold text-purple-500">${playerStats[type].last?.rating || 'N/A'}</div>
                                <div class="text-gray-400">Peak: ${playerStats[type].best?.rating || 'N/A'}</div>
                            </div>
                        `).join('')}
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-2xl font-bold mb-4">Puzzles</h3>
                            <div class="text-3xl font-bold text-purple-500">${playerStats.puzzle.last?.rating || 'N/A'}</div>
                            <div class="text-gray-400">Peak: ${playerStats.puzzle.best?.rating || 'N/A'}</div>
                        </div>
                    </div>
                    <button onclick="nextSlide()" class="mt-8 bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Next →
                    </button>
                </div>
            `;
            container.appendChild(ratingSlide);

            // Achievements slide
            const achievementsSlide = createSlide();
            const bestWinDate = playerStats.games.bestWin.date?.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            achievementsSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-4xl font-bold mb-8">Your Achievements</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto px-4">
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Best Victory</h3>
                            <div class="text-3xl font-bold text-yellow-500">Rating ${playerStats.games.bestWin.rating}</div>
                            <div class="text-gray-400 text-sm">
                                Against ${playerStats.games.bestWin.opponent}<br>
                                ${bestWinDate}<br>
                                <a href="${playerStats.games.bestWin.gameUrl}" target="_blank" class="text-blue-400 hover:text-blue-300">View Game →</a>
                            </div>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                            <h3 class="text-xl font-bold mb-2">Fastest Win</h3>
                            <div class="text-3xl font-bold text-green-500">${playerStats.games.fastestWin.moves} moves</div>
                            <div class="text-gray-400 text-sm">
                                Against ${playerStats.games.fastestWin.opponent}<br>
                                <a href="${playerStats.games.fastestWin.gameUrl}" target="_blank" class="text-blue-400 hover:text-blue-300">View Game →</a>
                            </div>
                        </div>
                    </div>
                    ${playerStats.games.averageAccuracy ? `
                        <div class="mt-6 bg-gray-900 p-6 rounded-lg shadow-lg stat-card max-w-2xl w-full">
                            <h3 class="text-xl font-bold mb-4">Average Accuracy</h3>
                            <div class="text-3xl font-bold text-blue-500">${playerStats.games.averageAccuracy}%</div>
                        </div>
                    ` : ''}
                    <div class="mt-8 bg-gray-900 p-6 rounded-lg shadow-lg stat-card max-w-2xl w-full">
                        <h3 class="text-xl font-bold mb-4">Most Played Openings</h3>
                        <div class="space-y-2">
                            ${playerStats.games.topOpenings?.map(([opening, count], index) => `
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300">${index + 1}. ${opening}</span>
                                    <span class="text-gray-400">${count} games</span>
                                </div>
                            `).join('') || 'No opening data available'}
                        </div>
                    </div>
                    <button onclick="nextSlide()" class="mt-8 bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg">
                        Next →
                    </button>
                </div>
            `;
            container.appendChild(achievementsSlide);

            // Final slide with download option
            const finalSlide = createSlide();
            finalSlide.innerHTML = `
                <div class="h-screen flex flex-col justify-center items-center">
                    <h2 class="text-5xl font-bold mb-8 gradient-text">Thanks for watching!</h2>
                    <p class="text-2xl mb-8">Want to share your chess journey?</p>
                    <button onclick="showSummaryCard()" class="bg-green-500 hover:bg-green-600 px-8 py-3 rounded-full font-bold text-lg mb-4">
                        Generate Summary Card
                    </button>
                    <button onclick="location.reload()" class="bg-gray-700 hover:bg-gray-600 px-8 py-3 rounded-full font-bold text-lg">
                        Start Over
                    </button>
                </div>
            `;
            container.appendChild(finalSlide);

            // Hidden summary card container
            const summaryCardContainer = document.createElement('div');
            summaryCardContainer.id = 'summary-card-container';
            summaryCardContainer.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 overflow-auto p-4';
            summaryCardContainer.innerHTML = `
                <div id="summary-card" class="relative bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-8 rounded-xl shadow-2xl mx-auto my-8" style="max-width: 1200px;">
                    <div class="absolute inset-0" style="
                        background-image: 
                            linear-gradient(45deg, rgba(40, 40, 40, 0.7) 25%, transparent 25%),
                            linear-gradient(-45deg, rgba(40, 40, 40, 0.7) 25%, transparent 25%),
                            linear-gradient(45deg, transparent 75%, rgba(40, 40, 40, 0.7) 75%),
                            linear-gradient(-45deg, transparent 75%, rgba(40, 40, 40, 0.7) 75%);
                        background-size: 80px 80px;
                        background-position: 0 0, 0 40px, 40px -40px, -40px 0px;
                        filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.3));
                    "></div>
                    <div class="relative flex flex-col z-10">
                        <!-- Header with Avatar -->
                        <div class="text-center mb-8">
                            <div class="flex items-center justify-center mb-4">
                                <img src="${playerAvatar}" alt="Player Avatar" class="w-20 h-20 rounded-full border-2 border-green-500 mr-4">
                                <div class="space-y-4">
                                    <h2 class="text-6xl font-bold text-white" style="letter-spacing: normal;">Chess.com Wrapped 2024</h2>
                                    <p class="text-2xl text-gray-400" style="letter-spacing: normal; word-spacing: 0.1em;">Year in Review for <span class="font-bold text-white">${playerName}</span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Main Grid -->
                        <div class="grid grid-cols-3 gap-6">
                            <!-- Overall Stats -->
                            <div class="bg-gray-800 bg-opacity-50 p-6 rounded-xl border border-gray-700">
                                <h3 class="text-2xl font-bold mb-4 text-white">Overall Performance</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-4">
                                        <div>
                                            <div class="text-4xl font-bold text-green-500">${playerStats.games.total}</div>
                                            <div class="text-gray-400">Games Played</div>
                                        </div>
                                        <div>
                                            <div class="text-4xl font-bold text-yellow-500">${((playerStats.games.wins / playerStats.games.total) * 100).toFixed(1)}%</div>
                                            <div class="text-gray-400">Win Rate</div>
                                        </div>
                                        <div>
                                            <div class="text-4xl font-bold text-blue-500">${playerStats.games.bestWinStreak}</div>
                                            <div class="text-gray-400">Best Streak</div>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <div class="text-4xl font-bold text-green-500">${playerStats.games.wins}</div>
                                            <div class="text-gray-400">Wins</div>
                                        </div>
                                        <div>
                                            <div class="text-4xl font-bold text-orange-500">${playerStats.games.draws}</div>
                                            <div class="text-gray-400">Draws</div>
                                        </div>
                                        <div>
                                            <div class="text-4xl font-bold text-red-500">${playerStats.games.losses}</div>
                                            <div class="text-gray-400">Losses</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ratings -->
                            <div class="bg-gray-800 bg-opacity-50 p-6 rounded-xl border border-gray-700">
                                <h3 class="text-2xl font-bold mb-4 text-white">Rating Progress</h3>
                                <div class="space-y-4">
                                    ${['bullet', 'blitz', 'rapid'].map(type => `
                                        <div>
                                            <div class="text-lg text-gray-400">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                                            <div class="flex items-baseline space-x-2">
                                                <div class="text-3xl font-bold text-purple-500">${playerStats[type].last?.rating || 'N/A'}</div>
                                                ${playerStats[type].best?.rating ? `
                                                    <div class="text-sm text-gray-400">
                                                        Peak: <span class="text-purple-400">${playerStats[type].best.rating}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Time Control Stats -->
                            <div class="bg-gray-800 bg-opacity-50 p-6 rounded-xl border border-gray-700">
                                <h3 class="text-2xl font-bold mb-4 text-white">Time Control Stats</h3>
                                <div class="space-y-4">
                                    ${['bullet', 'blitz', 'rapid'].map(type => `
                                        <div>
                                            <div class="text-lg text-gray-400">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                                            <div class="grid grid-cols-3 gap-2 text-sm">
                                                <div>
                                                    <div class="text-green-500 font-bold">${playerStats[type].record?.win || 0}</div>
                                                    <div class="text-gray-500">Wins</div>
                                                </div>
                                                <div>
                                                    <div class="text-orange-500 font-bold">${playerStats[type].record?.draw || 0}</div>
                                                    <div class="text-gray-500">Draws</div>
                                                </div>
                                                <div>
                                                    <div class="text-red-500 font-bold">${playerStats[type].record?.loss || 0}</div>
                                                    <div class="text-gray-500">Losses</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Playing Patterns -->
                            <div class="bg-gray-800 bg-opacity-50 p-6 rounded-xl border border-gray-700">
                                <h3 class="text-2xl font-bold mb-4 text-white">Playing Patterns</h3>
                                <div class="space-y-4">
                                    <div>
                                        <div class="text-lg text-gray-400">Peak Activity</div>
                                        <div class="text-2xl font-bold text-yellow-500">
                                            ${(() => {
                                                const time = Object.entries(playerStats.games.timeOfDay)
                                                    .sort((a, b) => b[1] - a[1])[0];
                                                const timeMap = {
                                                    morning: '🌅 Morning',
                                                    afternoon: '☀️ Afternoon',
                                                    evening: '🌆 Evening',
                                                    night: '🌙 Night'
                                                };
                                                return `${timeMap[time[0]]} (${time[1]} games)`;
                                            })()}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-lg text-gray-400">Favorite Day</div>
                                        <div class="text-2xl font-bold text-yellow-500">
                                            ${(() => {
                                                const day = Object.entries(playerStats.games.dayOfWeek)
                                                    .sort((a, b) => b[1] - a[1])[0];
                                                const dayMap = {
                                                    mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday',
                                                    thu: 'Thursday', fri: 'Friday', sat: 'Saturday',
                                                    sun: 'Sunday'
                                                };
                                                return `${dayMap[day[0]]} (${day[1]} games)`;
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Best Victory -->
                            <div class="bg-gray-800 bg-opacity-50 p-6 rounded-xl border border-gray-700">
                                <h3 class="text-2xl font-bold mb-4 text-white">Greatest Victory</h3>
                                <div class="space-y-2">
                                    <div class="text-4xl font-bold text-red-500">${playerStats.games.bestWin.rating}</div>
                                    <div class="text-lg text-gray-400">Opponent Rating</div>
                                    <div class="text-xl text-white">vs ${playerStats.games.bestWin.opponent}</div>
                                    <div class="text-sm text-gray-500">
                                        ${new Date(playerStats.games.bestWin.date).toLocaleDateString('en-US', {
                                            month: 'long',
                                            day: 'numeric',
                                            year: 'numeric'
                                        })}
                                    </div>
                                </div>
                            </div>

                            <!-- Game Records -->
                            <div class="bg-gray-800 bg-opacity-50 p-6 rounded-xl border border-gray-700">
                                <h3 class="text-2xl font-bold mb-4 text-white">Game Records</h3>
                                <div class="space-y-4">
                                    <div>
                                        <div class="text-lg text-gray-400">Fastest Victory</div>
                                        <div class="text-2xl font-bold text-teal-500">${playerStats.games.fastestWin.moves} moves</div>
                                        <div class="text-sm text-gray-400">vs ${playerStats.games.fastestWin.opponent}</div>
                                    </div>
                                    <div>
                                        <div class="text-lg text-gray-400">Longest Battle</div>
                                        <div class="text-2xl font-bold text-teal-500">${playerStats.games.longestGame.moves} moves</div>
                                        <div class="text-sm text-gray-400">vs ${playerStats.games.longestGame.opponent}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="text-center mt-12 pb-4 relative">
                            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-96 h-1 bg-gradient-to-r from-transparent via-green-500 to-transparent opacity-50"></div>
                            <div class="text-sm text-gray-400 mb-6" style="letter-spacing: normal; word-spacing: 0.1em;">Generated by Chess.com Wrapped • ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                    </div>
                </div>
                <button onclick="copyToClipboard()" class="fixed top-4 right-16 text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                    Copy
                </button>
                <button onclick="closeSummaryCard()" class="fixed top-4 right-4 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;
            document.body.appendChild(summaryCardContainer);
            
            showSlide(0);
        }

        function createSlide() {
            const slide = document.createElement('div');
            slide.className = 'slide';
            slides.push(slide);
            return slide;
        }

        function showSlide(index) {
            console.log('Showing slide:', index); // Debug log
            slides.forEach((slide, i) => {
                if (i === index) {
                    slide.classList.add('active');
                } else {
                    slide.classList.remove('active');
                }
            });
            currentSlide = index;
        }

        function nextSlide() {
            console.log('Current slide:', currentSlide, 'Total slides:', slides.length); // Debug log
            if (currentSlide < slides.length - 1) {
                showSlide(currentSlide + 1);
            }
        }

        function createTimeControlCard(title, stats) {
            return `
                <div class="bg-gray-900 p-6 rounded-lg shadow-lg stat-card">
                    <h3 class="text-2xl font-bold mb-4">${title}</h3>
                    <div class="text-4xl font-bold mb-2">${stats.last.rating}</div>
                    <div class="text-gray-400">Peak: ${stats.best.rating}</div>
                </div>
            `;
        }

        function updateLoadingText(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function updateProgress(percent) {
            document.getElementById('progress-bar').style.width = `${percent}%`;
        }

        function showSummaryCard() {
            document.getElementById('summary-card-container').classList.remove('hidden');
        }

        function closeSummaryCard() {
            document.getElementById('summary-card-container').classList.add('hidden');
        }

        async function downloadSummaryCard() {
            try {
                console.log('Starting download process...');
                const originalCard = document.getElementById('summary-card');
                if (!originalCard) {
                    console.error('Original card not found');
                    return;
                }

                // Create a temporary container
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '0';
                tempContainer.style.top = '0';
                tempContainer.style.width = '1920px';
                tempContainer.style.height = '1080px';
                tempContainer.style.visibility = 'hidden';
                document.body.appendChild(tempContainer);

                // Clone the card
                const downloadCard = originalCard.cloneNode(true);
                downloadCard.style.width = '1920px';
                downloadCard.style.height = '1080px';
                downloadCard.style.transform = 'none';
                downloadCard.style.maxWidth = 'none';
                downloadCard.style.position = 'absolute';
                downloadCard.style.left = '0';
                downloadCard.style.top = '0';
                tempContainer.appendChild(downloadCard);

                console.log('Starting html2canvas conversion...');
                const canvas = await html2canvas(downloadCard, {
                    scale: 1,
                    backgroundColor: '#111827',
                    logging: true,
                    width: 1920,
                    height: 1080,
                    useCORS: true,
                    allowTaint: true,
                    foreignObjectRendering: true,
                    removeContainer: true,
                    onclone: function(clonedDoc) {
                        console.log('Document cloned successfully');
                    }
                });

                console.log('Canvas generated, creating download link...');
                const dataUrl = canvas.toDataURL('image/png');
                
                // Create and click download link
                const link = document.createElement('a');
                link.download = `chess-wrapped-${username}-${new Date().getTime()}.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('Download initiated');

            } catch (error) {
                console.error('Error in downloadSummaryCard:', error);
                alert('There was an error generating the image. Please check the console for details.');
            } finally {
                // Clean up
                const tempContainer = document.querySelector('[style*="visibility: hidden"]');
                if (tempContainer) {
                    tempContainer.remove();
                }
                console.log('Cleanup completed');
            }
        }

        async function copyToClipboard() {
            try {
                const card = document.getElementById('summary-card');
                const canvas = await html2canvas(card, {
                    scale: 1,
                    backgroundColor: '#111827',
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    try {
                        // Create ClipboardItem
                        const item = new ClipboardItem({ 'image/png': blob });
                        await navigator.clipboard.write([item]);
                        
                        // Show success message
                        const button = document.querySelector('button[onclick="copyToClipboard()"]');
                        const originalText = button.innerHTML;
                        button.innerHTML = `
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Copied!
                        `;
                        setTimeout(() => {
                            button.innerHTML = originalText;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        alert('Failed to copy to clipboard. Please try again.');
                    }
                });
            } catch (error) {
                console.error('Error capturing image:', error);
                alert('Failed to capture image. Please try again.');
            }
        }
    </script>
</body>
</html>
